name: weighted-mtp-verifiable-4gpu
description: Verifiable WMTP A100 4-GPU 프로덕션 학습 (TD Error Weighting)
tags:
  - weighted-mtp
  - verifiable
  - td-weighting
  - a100
  - 4gpu
  - production
resources:
  cluster: vessl-kr-a100-80g-sxm
  preset: gpu-a100-80g-large
image: pytorch/pytorch:2.5.1-cuda12.4-cudnn9-devel
import:
  /app:
    git:
      url: github.com/wooshikwon/weighted_mtp.git
      ref: main
  /vessl/models: volume://vessl-storage/models
  /vessl/datasets: volume://vessl-storage/datasets
  /vessl/checkpoints: volume://vessl-storage/checkpoints
env:
  MLFLOW_TRACKING_USERNAME: "{{MLFLOW_TRACKING_USERNAME}}"
  MLFLOW_TRACKING_PASSWORD: "{{MLFLOW_TRACKING_PASSWORD}}"
  AWS_ACCESS_KEY_ID: "{{AWS_ACCESS_KEY_ID}}"
  AWS_SECRET_ACCESS_KEY: "{{AWS_SECRET_ACCESS_KEY}}"
  AWS_DEFAULT_REGION: "{{AWS_DEFAULT_REGION}}"
  HF_TOKEN: "{{HF_TOKEN}}"
  PYTHONUNBUFFERED: "1"
  TOKENIZERS_PARALLELISM: "false"
  NCCL_DEBUG: "INFO"
  CRITIC_CHECKPOINT: "{{CRITIC_CHECKPOINT}}"
run:
  - workdir: /app
    command: |
      set -e

      echo "=== 시스템 패키지 설치 ==="
      apt-get update && apt-get install -y curl git

      echo "=== UV 설치 ==="
      curl -LsSf https://astral.sh/uv/install.sh | sh
      export PATH="$HOME/.local/bin:$PATH"
      uv --version

      echo "=== Storage 심볼릭 링크 생성 ==="
      mkdir -p storage
      ln -s /vessl/models storage/models
      ln -s /vessl/datasets storage/datasets
      ln -s /vessl/checkpoints storage/checkpoints
      ls -lh storage/

      echo "=== Python 의존성 설치 ==="
      uv sync --frozen

      echo "=== GPU 정보 확인 ==="
      nvidia-smi

      echo "=== Storage Volume 확인 ==="
      echo "Models:"
      ls -lh storage/models/ | head -5
      echo "Datasets:"
      ls -lh storage/datasets/ | head -5
      echo "Checkpoints:"
      ls -lh storage/checkpoints/ | head -5

      echo "=== Critic Checkpoint 확인 ==="
      if [ -z "$CRITIC_CHECKPOINT" ]; then
        echo "경고: CRITIC_CHECKPOINT 환경변수가 설정되지 않았습니다"
        echo "기본값 사용: storage/checkpoints/critic/critic-pretrain/checkpoint_best.pt"
        CRITIC_CHECKPOINT="storage/checkpoints/critic/critic-pretrain/checkpoint_best.pt"
      fi
      echo "Critic checkpoint: $CRITIC_CHECKPOINT"
      ls -lh "$CRITIC_CHECKPOINT" || echo "경고: Checkpoint 파일이 존재하지 않습니다"

      echo "=== Verifiable WMTP 학습 시작 (4-GPU Distributed) ==="
      uv run torchrun \
        --nproc_per_node=4 \
        --nnodes=1 \
        --node_rank=0 \
        -m weighted_mtp.pipelines.run_verifiable \
        --config configs/verifiable/verifiable.yaml \
        --override experiment.critic_checkpoint="$CRITIC_CHECKPOINT"
